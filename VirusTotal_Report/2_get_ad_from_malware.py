import pandas as pd
import os
from tqdm import tqdm
import hashlib

def get_folder_files(folder: str) -> list:
    out_files = []
    files = [os.path.join(folder, f) for f in os.listdir(folder) ]
    for file in files:
        if os.path.isfile(file):
            out_files.append(file)
        elif os.path.isdir(file):
            out_files.extend(get_folder_files(file))
    return out_files

def get_file_sha256(file_path: str) -> str:
    with open(file_path, "rb") as f:
        file_data = f.read()
        sha256 = hashlib.sha256(file_data).hexdigest()
    return sha256


csv_file = "malware_example.csv"
df = pd.read_csv(csv_file)
malware_files = df["file_path"].values

adversarial_example_path = "E:\\python_test\\1ablation_experiment\\expansion\\expansion_2\\datasets_test_3500_evasion_expansion_2"
adversarial_example_files = get_folder_files(adversarial_example_path)
# print(f'adversarial_example_files: {adversarial_example_files}')

adversarial_example_files_name = [os.path.basename(f)+"_evasion" for f in malware_files]
adversarial_example_files = [f for f in adversarial_example_files if os.path.basename(f) in adversarial_example_files_name]
# print(f'adversarial_example_files: {adversarial_example_files}')
print(f'len(adversarial_example_files): {len(adversarial_example_files)}')


adversarial_example_csv = "adversarial_example.csv"


adversarial_example_df = pd.DataFrame()
adversarial_example_df["file_path"] = adversarial_example_files
adversarial_example_df["mal_type"] = [os.path.basename(os.path.dirname(f)) for f in adversarial_example_files]
adversarial_example_df["sha256"] = [get_file_sha256(f) for f in tqdm(adversarial_example_files,desc="sha256")]
adversarial_example_df.to_csv(adversarial_example_csv, index=False)
